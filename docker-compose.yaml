# Docker Compose file for preview environment using pre-built images

services:

  # Database service
  database:
    image: saurcode/osb_db:v2.1.1
    environment:
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      NEO4J_server_memory_heap_initial__size: "2G"
      NEO4J_server_memory_heap_max__size: "2G"
      NEO4J_server_memory_pagecache_size: "1G"
      NEO4J_server_default__listen__address: "0.0.0.0"
      NEO4J_server_default__advertised__address: "localhost"
      NEO4J_server_bolt_advertised__address: "localhost:5002"
      NEO4J_server_http_advertised__address: "localhost:5001"
      NEO4J_AUTH: "neo4j/${NEO4J_PASSWORD:-changeme1234}"
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:${NEO4J_BOLT_PORT:-5002}:7687"
      - "${BIND_ADDRESS:-0.0.0.0}:${NEO4J_HTTP_PORT:-5001}:7474"
    volumes:
      - type: volume
        source: data
        target: /data
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--spider", "http://localhost:7474"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 60s

  # API service
  api:
    image: saurcode/osb-api:latest
    depends_on:
      database:
        condition: service_healthy
    environment:
      NEO4J_DSN: "${NEO4J_DSN:-bolt://neo4j:changeme1234@database:7687/mdrdb}"
      ALLOW_ORIGIN_REGEX: "${ALLOW_ORIGIN_REGEX:-.*}"
      OAUTH_ENABLED: "${OAUTH_ENABLED:-False}"
      OAUTH_RBAC_ENABLED: "${OAUTH_RBAC_ENABLED:-False}"
      OAUTH_METADATA_URL: "${OAUTH_METADATA_URL:-}"
      OAUTH_API_APP_ID: "${OAUTH_API_APP_ID:-}"
      OAUTH_API_APP_SECRET: "${OAUTH_API_APP_SECRET:-}"
      OAUTH_SWAGGER_APP_ID: "${OAUTH_SWAGGER_APP_ID:-}"
      MS_GRAPH_INTEGRATION_ENABLED: "${MS_GRAPH_INTEGRATION_ENABLED:-}"
      MS_GRAPH_GROUPS_QUERY: "${MS_GRAPH_GROUPS_QUERY:-}"
      UVICORN_PORT: 5003
      UVICORN_ROOT_PATH: "/api"

  # Consumer API service
  consumerapi:
    image: saurcode/osb-consumerapi:v2.0.1
    depends_on:
      database:
        condition: service_healthy
    environment:
      NEO4J_DSN: "${NEO4J_DSN:-bolt://neo4j:changeme1234@database:7687/mdrdb}"
      ALLOW_ORIGIN_REGEX: "${ALLOW_ORIGIN_REGEX:-.*}"
      OAUTH_ENABLED: "${OAUTH_ENABLED:-False}"
      OAUTH_RBAC_ENABLED: "${OAUTH_RBAC_ENABLED:-False}"
      UVICORN_PORT: 5008
      UVICORN_ROOT_PATH: "/consumer-api"
      UVICORN_APP: consumer_api.consumer_api:app

  # Frontend service
  frontend:
    image: saurcode/osb_frontend:latest
    depends_on:
      api:
        condition: service_healthy
      documentation:
        condition: service_healthy
      neodash:
        condition: service_healthy
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:${FRONTEND_PORT:-5005}:5005"
    environment:
      API_BASE_URL: "${API_PATH:-}"
      DOC_BASE_URL: "${DOC_PATH:-}"
      NEODASH_BASE_URL: "${NEODASH_PATH:-}"
      OAUTH_ENABLED: "${OAUTH_ENABLED:-false}"
      POCKETBASE_BASE_URL: "${POCKETBASE_PUBLIC_URL:-http://localhost:8090}"

  # Documentation portal
  documentation:
    image: saurcode/osb-documentation:v2.0.1

  # Neodash service
  neodash:
    image: saurcode/osb-neodash:v2.0.1
    depends_on:
      database:
        condition: service_healthy
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:${NEODASH_PORT:-5007}:5007"
    environment:
      NGINX_PORT: 5007
      ssoEnabled: false
      ssoDiscoveryUrl: https://localhost.com
      standalone: true
      standaloneProtocol: neo4j
      standaloneHost: localhost
      standalonePort: 5002
      standaloneDatabase: mdrdb
      standaloneAllowLoad: true
      standaloneDashboardName: Activity Library Dashboard
      standaloneDashboardDatabase: mdrdb
      standaloneUsername: neo4j
      standalonePassword: "${NEO4J_PASSWORD:-changeme1234}"

  # PocketBase service
  pocketbase:
    image: saurcode/osb_pocketbase:latest
    container_name: pocketbase
    ports:
      - "${POCKETBASE_PORT:-8090}:8090"
    volumes:
      - ./pocketbase-db/pb_data:/pb_app/pb_data
    environment:
      POCKETBASE_ENV: "development"
      POCKETBASE_CORS_ORIGINS: "${POCKETBASE_CORS_ORIGINS:-http://localhost:5005,http://localhost:5173}"
      POCKETBASE_PUBLIC_URL: "${POCKETBASE_PUBLIC_URL:-http://localhost:8090}"
    restart: unless-stopped

  # Neo4J Backup Service
  neo4j-backup:
    image: saurcode/osb-backup:latest
    container_name: osb-backup
    depends_on:
      - database
    volumes:
      - data:/data
      - ./neo-backup:/backup
    environment:
      S3_BUCKET: ${S3_BUCKET}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}

volumes:
  data:
    name: studybuilder_database

